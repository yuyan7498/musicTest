<!DOCTYPE html>
<html>

<head>
    <title>琦琦的音樂測驗！</title>
    <link rel="stylesheet" href="./static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"
        integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
</head>

<body>

    <audio src="./triangle.mp3"></audio>

    <div id="startMenu">
        <h1>反應測驗工具</h1>
        <button id="startGame" onclick="startGame()">
            <span class="button_top">
                <h1>開始測驗</h1>
            </span>
        </button>
    </div>

    <div id="counter">
        <h3>請在聽到三角鐵聲音時按下按鈕</h3>
    </div>

    <div>
        <h1 id="counter2">3</h1>
    </div>

    <div id="test">
        <button class="testButton" id="timeRecorder">
            <svg viewBox="0 0 448 512" class="bell">
                <path
                    d="M224 0c-17.7 0-32 14.3-32 32V49.9C119.5 61.4 64 124.2 64 200v33.4c0 45.4-15.5 89.5-43.8 124.9L5.3 377c-5.8 7.2-6.9 17.1-2.9 25.4S14.8 416 24 416H424c9.2 0 17.6-5.3 21.6-13.6s2.9-18.2-2.9-25.4l-14.9-18.6C399.5 322.9 384 278.8 384 233.4V200c0-75.8-55.5-138.6-128-150.1V32c0-17.7-14.3-32-32-32zm0 96h8c57.4 0 104 46.6 104 104v33.4c0 47.9 13.9 94.6 39.7 134.6H72.3C98.1 328 112 281.3 112 233.4V200c0-57.4 46.6-104 104-104h8zm64 352H224 160c0 17 6.7 33.3 18.7 45.3s28.3 18.7 45.3 18.7s33.3-6.7 45.3-18.7s18.7-28.3 18.7-45.3z">
                </path>
            </svg>
        </button>
        <p id="timeLag"></p>
    </div>

    <div class="loaderRectangle">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>

    <div id="conclusion">
        <h1>成績</h1>
        <p>單位：毫秒</p>
        <div id="mainChart" style="width: 1000px;height:400px;"></div>
        <div id="average">
            <h2>平均反應速度</h2>
            <h2 id="score"></h2>
            <h2>毫秒</h2>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.1.2/echarts.min.js"></script>


    <script>

        $(document).ready(function () {
            $("#test").hide();
            $("#startMenu").hide();
            $('#counter').hide();
            $('#counter2').hide();
            $("#startMenu").fadeIn(1000);
            $('.loaderRectangle').hide();
            $('#conclusion').hide();
        });


        var notes = ["C3", "D3", "E3", "F3", "G3", "A3", "B3"];
        const itsNowButton = document.getElementById("timeRecorder");
        var answers = [];

        function startRecorder(triangleTime) {

            var currentTime;
            var isClick = 0;
            function recordTime() {
                currentTime = (new Date()).valueOf();
                itsNowButton.removeEventListener("click", recordTime);
                isClick = 1
                answers.push(currentTime - triangleTime);
                console.log(currentTime - triangleTime);
                $('#timeLag').text(currentTime - triangleTime);
            }

            itsNowButton.addEventListener("click", recordTime);
            //發出聲音後三秒內必須點擊
            setTimeout(() => {
                itsNowButton.removeEventListener("click", recordTime);
                if (isClick === 0) {
                    answers.push(2000);
                    $('#timeLag').text("miss");
                    console.log("miss");
                } else if (isClick === 1) {
                    isClick = 0;
                }

            }, 2000);
        }

        function playRandomNote() {
            const synth = new Tone.Synth().toDestination();
            var randomNote = notes[getRandomInt(0, 6)]
            synth.triggerAttackRelease(randomNote, "0.5n");
        }

        function playMusic() {
            for (var timeIndex = 0; timeIndex < 120000; timeIndex += 500) {
                setTimeout(function () {
                    playRandomNote();
                }, timeIndex);
            }
        }

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min) + min); //The maximum is exclusive and the minimum is inclusive
        }

        function playAudio() {
            const player = new Tone.Player().toDestination();
            player.load('./triangle.mp3');
            Tone.loaded().then(() => {
                player.start();
            });
        }

        function randTheSound() {
            var randNotesList = [];
            removeList = [];
            for (var i = 0; i < 30; i++) {
                randNotesList.push(getRandomInt(3, 119));
            }
            randNotesList.sort(function (a, b) {
                if (a > b) return 1;
                if (a < b) return -1;
                return 0;
            });

            for (var listI = 0; listI < randNotesList.length - 1; listI++) {
                if (randNotesList[listI + 1] - randNotesList[listI] <= 2) {
                    removeList.push(randNotesList[listI]);
                }
            }

            removeList.forEach(element => {
                for (var i = 0; i < randNotesList.length; i++) {
                    if (randNotesList[i] === element) {
                        randNotesList.splice(i, 1);
                        break;
                    }
                }
            });

            for (var j = 0; j < removeList.length; j++) {
                for (var listI = 0; listI < randNotesList.length - 1; listI++) {
                    if (randNotesList[listI + 1] - randNotesList[listI] > 4) {
                        randNotesList.push(getRandomInt(randNotesList[listI] + 3, randNotesList[listI + 1] - 3));
                        randNotesList.sort(function (a, b) {
                            if (a > b) return 1;
                            if (a < b) return -1;
                            return 0;
                        });
                        break;
                    }
                }
            }

            return randNotesList;

        }

        function randomPlayAudio() {
            timeIndex = randTheSound();
            timeIndex.forEach(element => {
                setTimeout(function () {
                    playAudio();
                    triangleTime = (new Date()).valueOf();
                    startRecorder(triangleTime);
                }, element * 1000)
            });
        }

        function startGame() {
            $("#startMenu").fadeOut(1000);
            setTimeout(function () {
                $('#counter').fadeIn(1000);
            }, 1000)
            setTimeout(function () {
                $('#counter').fadeOut(1000);
            }, 2000)
            setTimeout(function () {
                $('#counter2').fadeIn(1000);
            }, 3000)
            setTimeout(function () {
                $('#counter2').text("2");
            }, 4000)
            setTimeout(function () {
                $('#counter2').text("1");
            }, 5000)
            setTimeout(function () {
                $('#counter2').fadeOut(1000);
            }, 6000)
            setTimeout(function () {
                $('#test').fadeIn(1000);
                playMusic();
                randomPlayAudio();
            }, 7000)
            setTimeout(function () {
                $('#test').hide();
                $('.loaderRectangle').show();
            }, 127000)
            setTimeout(function () {
                $('.loaderRectangle').hide();
                $('#conclusion').show();

                var chartDom = document.getElementById('mainChart');
                var myChart = echarts.init(chartDom);
                var option;

                var chartX = []
                for (var i = 1; i < 31; i++) {
                    chartX.push(i);
                }

                option = {
                    xAxis: {
                        type: 'category',
                        data: chartX
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: [
                        {
                            data: answers,
                            type: 'line'
                        }
                    ]
                };

                option && myChart.setOption(option);

                var score = 0;
                answers.forEach(element => {
                    score += element;
                });
                score = (score / answers.length).toFixed(2);
                $("#score").text(score);

            }, 128000)

        }


    </script>
</body>

</html>